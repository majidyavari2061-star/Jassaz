<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¬Ø§Ø³Ø§Ø² Ø¯Ú©ØªØ± Ù…Ø¬ÛŒØ¯ ÙÛŒØ§Ø¶ÛŒÙ¾ÙˆØ±</title>
<link rel="manifest" href="manifest.json">
<style>
  :root{--accent:#0b84ff}
  body{font-family:Tahoma, Arial, sans-serif;background:#f5f7fb;margin:0;padding:14px;color:#111}
  .card{background:#fff;border-radius:10px;padding:12px;margin-bottom:12px;box-shadow:0 6px 14px rgba(10,20,40,0.06)}
  h1{margin:0 0 6px;font-size:18px;text-align:center}
  label{display:block;margin-top:8px;font-size:14px}
  input,textarea,button,select{font-size:15px;padding:10px;border-radius:8px;border:1px solid #e6eef9;box-sizing:border-box}
  button{background:var(--accent);color:#fff;border:none}
  .row{display:flex;gap:8px;margin-top:8px}
  .list{margin-top:12px}
  .item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;background:#fff;border:1px solid #eef6ff}
  .thumb{width:64px;height:64px;border-radius:8px;background:#ddd;object-fit:cover}
  .meta{flex:1}
  .actions{display:flex;flex-direction:column;gap:6px}
  .nav-panel{display:none;padding:14px;border-radius:10px;background:#fff;border:1px solid #eee;margin-top:14px;text-align:center}
  .arrow{width:140px;height:140px;margin:auto;display:flex;align-items:center;justify-content:center}
  .arrow svg{width:100%;height:100%;transform-origin:center center;transition:transform 150ms linear}
  .distance{font-weight:700;margin-top:8px}
  .muted{color:#666;font-size:13px}
</style>
</head>
<body>

<div class="card">
  <h1>Ø¬Ø§Ø³Ø§Ø² Ø¯Ú©ØªØ± Ù…Ø¬ÛŒØ¯ ÙÛŒØ§Ø¶ÛŒâ€ŒÙ¾ÙˆØ±</h1>
  <div class="muted" style="text-align:center">Ø°Ø®ÛŒØ±Ù‡Ù” Ù†Ù‚Ø·Ù‡ Ø¨Ø§ Ø¹Ú©Ø³ â€” Ø¬Ø³ØªØ¬Ùˆ Ùˆ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø¨Ø§ ÙÙ„Ø´ â€” Ù‡Ø´Ø¯Ø§Ø± Ø¯Ø± Ù†Ø²Ø¯ÛŒÚ©ÛŒ</div>
</div>

<div class="card">
  <label>Ù†Ø§Ù… Ù…Ú©Ø§Ù†</label>
  <input id="name" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ú©Ù„ÛŒØ¯ Ø²ÛŒØ± Ø®Ø§Ú©" />
  <label>ØªÙˆØ¶ÛŒØ­Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
  <textarea id="desc" rows="2" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ú©Ù†Ø§Ø± Ø¯Ø±Ø®Øª"></textarea>

  <label style="margin-top:8px">Ø¹Ú©Ø³ (Ø¯ÙˆØ±Ø¨ÛŒÙ† ÛŒØ§ Ú¯Ø§Ù„Ø±ÛŒ)</label>
  <input id="photoInput" type="file" accept="image/*" capture="environment">

  <div class="row">
    <button id="saveBtn">ğŸ“ Ø°Ø®ÛŒØ±Ù‡ Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ</button>
    <button id="quickSaveBtn" style="background:#2a9d8f">âš¡ Ø°Ø®ÛŒØ±Ù‡ Ø³Ø±ÛŒØ¹</button>
    <button id="enableSensorsBtn" style="background:#444">âš™ï¸ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø­Ø³Ú¯Ø± Ø¬Ù‡Øª</button>
  </div>
  <div class="muted" style="margin-top:8px">Ù†Ú©ØªÙ‡: Ø¨Ø±Ø§ÛŒ Ø¯Ù‚Øª Ø¨ÛŒØ´ØªØ± Ù‚Ø¨Ù„ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡ Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø± Ú©Ù† ØªØ§ GPS Ù‚ÙÙ„ Ú©Ù†Ø¯.</div>
</div>

<div class="card">
  <h3 style="margin:0 0 8px">Ù„ÛŒØ³Øª Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§</h3>
  <div id="list" class="list"></div>
</div>

<!-- Ù¾Ù†Ù„ Ù†Ø§ÙˆØ¨Ø±ÛŒ -->
<div id="navPanel" class="nav-panel">
  <div id="navTitle" style="font-weight:800">Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...</div>
  <div class="arrow"><svg viewBox="0 0 100 100"><polygon points="50,5 90,95 50,75 10,95" fill="#0b84ff" id="arrowShape"/></svg></div>
  <div class="distance" id="distanceText">ÙØ§ØµÙ„Ù‡: --</div>
  <div class="muted" id="bearingText">Ø¬Ù‡Øª Ù‡Ø¯Ù: --</div>
  <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
    <button id="stopNav" style="background:#d33">ØªÙˆÙ‚Ù</button>
    <button id="openMap" style="background:#666">Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯Ø± Ù†Ù‚Ø´Ù‡</button>
  </div>
</div>

<script>
/* ===== Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ø§Ø¯Ù‡ Ø¨Ø§ localStorage ===== */
const KEY = "jasaaz_points_v4";
let points = JSON.parse(localStorage.getItem(KEY) || "[]");
const nameInput = document.getElementById("name");
const descInput = document.getElementById("desc");
const photoInput = document.getElementById("photoInput");
const listDiv = document.getElementById("list");
const saveBtn = document.getElementById("saveBtn");
const quickSaveBtn = document.getElementById("quickSaveBtn");
const enableSensorsBtn = document.getElementById("enableSensorsBtn");

nameInput.value = "Ø¬Ø§Ø³Ø§Ø² Ø¯Ú©ØªØ± Ù…Ø¬ÛŒØ¯ ÙÛŒØ§Ø¶ÛŒâ€ŒÙ¾ÙˆØ±";
let currentImageData = null;

// Ø®ÙˆØ§Ù†Ø¯Ù† Ø¹Ú©Ø³ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø¨Ù‡ dataURL
photoInput.addEventListener("change", async (e) => {
  const f = e.target.files && e.target.files[0];
  if(!f) { currentImageData = null; return; }
  const reader = new FileReader();
  reader.onload = () => { currentImageData = reader.result; };
  reader.readAsDataURL(f);
});

/* Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª */
function renderList(){
  listDiv.innerHTML = "";
  if(points.length===0){ listDiv.innerHTML = '<div class="muted">Ù‡ÛŒÚ† Ù†Ù‚Ø·Ù‡â€ŒØ§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡.</div>'; return; }
  points.forEach((p, i) => {
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <img class="thumb" src="${p.image||''}" onerror="this.style.display='none'"/>
      <div class="meta">
        <div style="font-weight:700">${escapeHtml(p.name)}</div>
        <div class="muted">${escapeHtml(p.desc)}</div>
        <div class="muted">Ø¹Ø±Ø¶: ${p.lat.toFixed(7)}, Ø·ÙˆÙ„: ${p.lng.toFixed(7)}</div>
      </div>
      <div class="actions">
        <button onclick="startNav('${p.id}')">ğŸ” Ø¬Ø³ØªØ¬Ùˆ</button>
        <button onclick="openMap(${p.lat},${p.lng})" style="background:#0b84ff">Ù†Ù‚Ø´Ù‡</button>
        <button onclick="downloadPoint('${p.id}')" style="background:#777">Ø¯Ø§Ù†Ù„ÙˆØ¯</button>
        <button onclick="deletePoint('${p.id}')" style="background:#e55">Ø­Ø°Ù</button>
      </div>
    `;
    listDiv.appendChild(el);
  });
}
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‚Ø·Ù‡ */
function addPoint(lat,lng,name,desc,image){
  const id = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
  points.push({ id, name: name||"Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…", desc: desc||"", lat:+lat, lng:+lng, created: Date.now(), image: image || null });
  localStorage.setItem(KEY, JSON.stringify(points));
  renderList();
}

/* Ø¯Ú©Ù…Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ù‚ÛŒÙ‚ */
saveBtn.addEventListener("click", ()=>{
  if(!navigator.geolocation){ alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Geolocation Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯."); return; }
  saveBtn.disabled = true; saveBtn.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ú¯Ø±ÙØªÙ† Ù…ÙˆÙ‚Ø¹ÛŒØª...";
  navigator.geolocation.getCurrentPosition(pos=>{
    addPoint(pos.coords.latitude, pos.coords.longitude, nameInput.value, descInput.value, currentImageData);
    saveBtn.disabled = false; saveBtn.textContent = "ğŸ“ Ø°Ø®ÛŒØ±Ù‡ Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ";
    nameInput.value = "Ø¬Ø§Ø³Ø§Ø² Ø¯Ú©ØªØ± Ù…Ø¬ÛŒØ¯ ÙÛŒØ§Ø¶ÛŒâ€ŒÙ¾ÙˆØ±";
    descInput.value = "";
    photoInput.value = "";
    currentImageData = null;
    alert("Ù…Ú©Ø§Ù† Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.");
  }, err=>{
    saveBtn.disabled = false; saveBtn.textContent = "ğŸ“ Ø°Ø®ÛŒØ±Ù‡ Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ";
    alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª: " + err.message);
  }, { enableHighAccuracy:true, timeout:15000, maximumAge:5000 });
});

/* Ø°Ø®ÛŒØ±Ù‡ Ø³Ø±ÛŒØ¹ Ø¨Ø§ Ù†Ø§Ù… Ù¾ÛŒØ´â€ŒÙØ±Ø¶ */
quickSaveBtn.addEventListener("click", ()=>{
  if(!navigator.geolocation){ alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Geolocation Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯."); return; }
  quickSaveBtn.disabled = true; quickSaveBtn.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ú¯Ø±ÙØªÙ† Ù…ÙˆÙ‚Ø¹ÛŒØª...";
  navigator.geolocation.getCurrentPosition(pos=>{
    addPoint(pos.coords.latitude, pos.coords.longitude, "Ø¬Ø§Ø³Ø§Ø² Ø¯Ú©ØªØ± Ù…Ø¬ÛŒØ¯ ÙÛŒØ§Ø¶ÛŒâ€ŒÙ¾ÙˆØ±", descInput.value||"", currentImageData);
    quickSaveBtn.disabled = false; quickSaveBtn.textContent = "âš¡ Ø°Ø®ÛŒØ±Ù‡ Ø³Ø±ÛŒØ¹";
    descInput.value = ""; photoInput.value = ""; currentImageData = null;
    alert("Ù…Ú©Ø§Ù† Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.");
  }, err=>{
    quickSaveBtn.disabled = false; quickSaveBtn.textContent = "âš¡ Ø°Ø®ÛŒØ±Ù‡ Ø³Ø±ÛŒØ¹";
    alert("Ø®Ø·Ø§: " + err.message);
  }, { enableHighAccuracy:true, timeout:15000, maximumAge:5000 });
});

/* Ø­Ø°ÙØŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ */
function deletePoint(id){
  if(!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù†Ù‚Ø·Ù‡ Ù…Ø·Ù…Ø¦Ù†ÛŒØŸ")) return;
  points = points.filter(p=>p.id!==id); localStorage.setItem(KEY, JSON.stringify(points)); renderList();
}
function downloadPoint(id){
  const p = points.find(x=>x.id===id);
  if(!p) return alert("Ù†Ù‚Ø·Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯");
  // Ø¯Ø§Ù†Ù„ÙˆØ¯ JSON Ø´Ø§Ù…Ù„ Ù…ØªØ§Ø¯ÛŒØªØ§ Ùˆ ØªØµÙˆÛŒØ± (Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯)
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([JSON.stringify(p, null, 2)], {type:"application/json"}));
  a.download = (p.name||"point") + ".json";
  a.click();
}

/* Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯Ø± Ù†Ù‚Ø´Ù‡ */
function openMap(lat,lng){
  window.open(`https://maps.google.com/?q=${lat},${lng}`, "_blank");
}

/* ===== Ù†Ø§ÙˆØ¨Ø±ÛŒ (ÙØ§ØµÙ„Ù‡ØŒ Ø¬Ù‡ØªØŒ Ú©Ù…Ù¾Ø§Ø³ØŒ Ø¨ÙˆÙ‚) ===== */
const navPanel = document.getElementById("navPanel");
const arrowShape = document.getElementById("arrowShape");
const distanceText = document.getElementById("distanceText");
const bearingText = document.getElementById("bearingText");
const stopNavBtn = document.getElementById("stopNav");
const openMapBtn = document.getElementById("openMap");

let navTarget = null;
let watchId = null;
let currentHeading = null;
let deviceOrientationActive = false;
let audioCtx = null;
let beepIntervalId = null;
let continuousOsc = null;

// Ø¢Ø³ØªØ§Ù†Ù‡â€ŒÙ‡Ø§ (Ù…ØªØ±)
const THRESHERS = { far: 10, medium: 2, close: 0.3 };

function toRad(d){ return d*Math.PI/180; }
function toDeg(r){ return r*180/Math.PI; }

function haversineDistance(lat1,lon1,lat2,lon2){
  const R = 6371000;
  const Ï†1 = toRad(lat1), Ï†2 = toRad(lat2);
  const Î”Ï† = toRad(lat2-lat1), Î”Î» = toRad(lon2-lon1);
  const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function bearingTo(lat1,lon1,lat2,lon2){
  const Ï†1 = toRad(lat1), Ï†2 = toRad(lat2);
  const Î»1 = toRad(lon1), Î»2 = toRad(lon2);
  const y = Math.sin(Î»2
